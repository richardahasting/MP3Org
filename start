#!/bin/bash
# start - Launch MP3Org (backend + frontend)
#
# Usage: ./start
#
# Starts both the Spring Boot backend (port 9090) and
# React frontend (port 5173), then opens the browser.
#
# Press Ctrl+C to stop both.

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Detect OS
detect_os() {
    case "$(uname -s)" in
        Darwin*)    echo "macos" ;;
        Linux*)     echo "linux" ;;
        MINGW*|CYGWIN*|MSYS*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

OS=$(detect_os)

# Cleanup function to kill both processes on exit
cleanup() {
    echo ""
    echo "Shutting down..."
    [ -n "$BACKEND_PID" ] && kill $BACKEND_PID 2>/dev/null
    [ -n "$FRONTEND_PID" ] && kill $FRONTEND_PID 2>/dev/null
    # Kill any remaining processes on our ports
    if [ "$OS" = "linux" ]; then
        fuser -k 9090/tcp 2>/dev/null || true
        fuser -k 5173/tcp 2>/dev/null || true
    else
        lsof -ti:9090 | xargs kill 2>/dev/null || true
        lsof -ti:5173 | xargs kill 2>/dev/null || true
    fi
    exit 0
}

trap cleanup SIGINT SIGTERM

echo "=========================================="
echo "  Starting MP3Org"
echo "=========================================="
echo ""

# Check if frontend dependencies are installed
if [ ! -d "$SCRIPT_DIR/frontend/node_modules" ]; then
    echo "Installing frontend dependencies..."
    cd "$SCRIPT_DIR/frontend"
    npm install
    cd "$SCRIPT_DIR"
    echo ""
fi

# Start backend
echo "Starting backend (port 9090)..."
./gradle21 bootRun &
BACKEND_PID=$!

# Wait for backend to be ready
echo "Waiting for backend..."
for i in {1..30}; do
    if curl -s http://localhost:9090/api/v1/music/count > /dev/null 2>&1; then
        echo "Backend ready."
        break
    fi
    sleep 1
done

# Start frontend
echo "Starting frontend (port 5173)..."
cd "$SCRIPT_DIR/frontend"
npm run dev &
FRONTEND_PID=$!
cd "$SCRIPT_DIR"

# Wait for frontend to be ready
echo "Waiting for frontend..."
sleep 3

echo ""
echo "=========================================="
echo "  MP3Org is running!"
echo ""
echo "  Open: http://localhost:5173"
echo ""
echo "  Press Ctrl+C to stop"
echo "=========================================="

# Open browser
sleep 2
case "$OS" in
    macos)
        open http://localhost:5173
        ;;
    linux)
        xdg-open http://localhost:5173 2>/dev/null || true
        ;;
    windows)
        start http://localhost:5173 2>/dev/null || true
        ;;
esac

# Wait for either process to exit
wait
